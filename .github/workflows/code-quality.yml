name: Format & Lint Check (CI)

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # Lint and Format Check - Python Code
  lint-python:
    name: ðŸ Python Lint & Format
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/requirements*.txt
            **/pyproject.toml
            **/uv.lock
          prune-cache: true

      - name: Install Python dev dependencies
        run: |
          cd apps/workers && uv sync --group dev
          cd ../ml-services && uv sync --group dev 2>/dev/null || echo "ML services has no dev dependencies yet"

      # Check formatting
      - name: Ruff Format Check
        run: uv run ruff format --check --diff apps/
        continue-on-error: true

      # Check linting
      - name: Ruff Lint Check
        run: uv run ruff check --output-format=github apps/
        continue-on-error: true

  # Type Check - Python Code (Pyrefly)
  typecheck-python:
    name: ðŸ Python Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/requirements*.txt
            **/pyproject.toml
            **/uv.lock

      - name: Install Python dev dependencies
        run: |
          cd apps/workers && uv sync --group dev
          cd ../ml-services && uv sync --group dev 2>/dev/null || echo "ML services has no dev dependencies yet"

      - name: Pyrefly Type Check - Workers
        run: uv run pyrefly check apps/workers/src/
        continue-on-error: true

      - name: Pyrefly Type Check - ML Services
        run: uv run pyrefly check apps/ml-services/ 2>/dev/null || echo "âš ï¸ ML Services type check skipped"
        continue-on-error: true

  # Lint and Format Check - TypeScript Code
  lint-typescript:
    name: ðŸ“˜ TypeScript Lint & Format
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Biome format check
      - name: Biome Format Check
        run: bun x @biomejs/biome format --check .
        continue-on-error: true

      # Biome lint check
      - name: Biome Lint Check
        run: bun x @biomejs/biome lint --output-format=github .
        continue-on-error: true

      # Oxlint for additional checks
      - name: Oxlint Check
        run: bun x oxlint --deny-warnings 2>&1 | tee oxlint-output.txt || true
        continue-on-error: true

      - name: Display Oxlint Results
        if: always()
        run: |
          if [ -s oxlint-output.txt ]; then
            echo "### Oxlint Results" >> $GITHUB_STEP_SUMMARY
            cat oxlint-output.txt >> $GITHUB_STEP_SUMMARY
          fi

  # Type Check - TypeScript Code
  typecheck-typescript:
    name: ðŸ“˜ TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: TypeScript Type Check
        run: bun run check-types
        continue-on-error: true

  # Summary
  quality-check-summary:
    name: Quality Checks Summary
    runs-on: ubuntu-latest
    needs:
      [lint-python, typecheck-python, lint-typescript, typecheck-typescript]
    if: always()

    steps:
      - name: Check Status
        run: |
          echo "## Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Python Lint & Format | ${{ needs.lint-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Python Type Check | ${{ needs.typecheck-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“˜ TypeScript Lint & Format | ${{ needs.lint-typescript.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“˜ TypeScript Type Check | ${{ needs.typecheck-typescript.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0
          [ "${{ needs.lint-python.result }}" != "success" ] && [ "${{ needs.lint-python.result }}" != "skipped" ] && FAILED=1
          [ "${{ needs.typecheck-python.result }}" != "success" ] && [ "${{ needs.typecheck-python.result }}" != "skipped" ] && FAILED=1
          [ "${{ needs.lint-typescript.result }}" != "success" ] && [ "${{ needs.lint-typescript.result }}" != "skipped" ] && FAILED=1
          [ "${{ needs.typecheck-typescript.result }}" != "success" ] && [ "${{ needs.typecheck-typescript.result }}" != "skipped" ] && FAILED=1

          if [ $FAILED -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ To fix issues locally:" >> $GITHUB_STEP_SUMMARY
            echo "**TypeScript/JavaScript:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "npm run fix              # Format & fix with ultracite" >> $GITHUB_STEP_SUMMARY
            echo "npm run check-types     # Type check" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Python:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "uv run ruff check --fix # Lint & auto-fix" >> $GITHUB_STEP_SUMMARY
            echo "uv run ruff format      # Format" >> $GITHUB_STEP_SUMMARY
            echo "pyrefly check src/      # Type check" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
